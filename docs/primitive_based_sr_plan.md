# Spaced Repetition System v3: Primitive-Centric Tracking

## 1. Overview & Goal

The goal of this new system is to shift the focus of spaced repetition from the `QuestionSet` level to the more granular `KnowledgePrimitive` level. This will allow for a more precise and adaptive learning experience, tracking a user's understanding of individual concepts, facts, and processes.

This document outlines the proposed data model changes, algorithm logic, and API endpoints required to implement this new system.

## 2. Core Concepts

*   **Knowledge Primitive (Locus):** The atomic unit of knowledge to be tracked. This can be a single fact, a definition, a step in a process, or a relationship between concepts.
*   **Mastery Criteria:** A set of specific, testable statements that define what it means to master a primitive. A primitive is not considered "mastered" until all its criteria are met.
*   **UEE Ladder (Understand, Use, Explore):** Each primitive and its associated criteria will be categorized into one of these three levels of understanding. The user progresses up the ladder as they demonstrate deeper mastery.
*   **Criterion Mastery:** A single criterion is met when the user masters at least one question linked to it.
*   **Primitive Mastery:** A primitive is mastered when all its associated Mastery Criteria are met.

## 3. From Blueprint JSON to Database Primitives

### Previous System: `QuestionSet`-Based SR

Previously, knowledge primitives were conceptual entities generated by the AI API and stored within a blueprint JSON file. The spaced repetition (SR) system operated on `QuestionSets`, which were derived from this blueprint. This approach lacked the granularity to track a user's mastery of individual concepts.

### New System: Primitive-Centric SR

The new system elevates `KnowledgePrimitives` to be first-class, trackable units within the core database. SR will now monitor and adapt to a user's progress on each specific primitive, rather than on a broad `QuestionSet`. This allows for a much more precise and personalized learning journey. The AI API's role will evolve to deconstruct source material directly into the new database models (`KnowledgePrimitive`, `MasteryCriterion`), making them persistent, core components of the application.

## 4. Proposed Data Model Changes (Prisma Schema)

We will need to introduce new models and update existing ones to support this new system.

```prisma
// In schema.prisma

model KnowledgePrimitive {
  id        Int      @id @default(autoincrement())
  userId    Int      // Every primitive must belong to a user
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  // ... other fields to define the primitive itself
  
  // --- Spaced Repetition Fields ---
  masteryCriteria MasteryCriterion[]
  isTracking      Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MasteryCriterion {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  primitiveId Int
  primitive   KnowledgePrimitive @relation(fields: [primitiveId], references: [id])
  
  description String // e.g., "Can state the definition of Photosynthesis"
  ueeLevel    String   // "Understand", "Use", or "Explore"
  weight      Int      @default(3) // 1-5 scale (5 = most critical for progression)
  difficulty  Int      @default(2) // 1-3 scale (3 = hardest to master)
  
  questions   Question[] // Questions that test this criterion
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// New model to track a user's progress on a specific primitive
model UserPrimitiveProgress {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  
  primitiveId Int
  primitive   KnowledgePrimitive @relation(fields: [primitiveId], references: [id])
  
  currentUeeLevel     String   @default("Understand")
  nextReviewAt        DateTime?
  lastReviewedAt      DateTime?
  currentIntervalStep Int      @default(0)  // Position on interval ladder
  consecutiveFailures Int      @default(0)  // Track repeated failures
  schedulingMode      String   @default("AUTO") // "AUTO" or "MANUAL"
  
  // The question that was answered to level up to the current UEE level
  answeredQuestionId Int?
  answeredQuestion   Question? @relation(fields: [answeredQuestionId], references: [id])
  
  @@unique([userId, primitiveId])
}

// New model to track a user's mastery of a specific criterion
model UserCriterionMastery {
  id                 Int      @id @default(autoincrement())
  userId             Int
  user               User     @relation(fields: [userId], references: [id])
  criterionId        Int
  criterion          MasteryCriterion @relation(fields: [criterionId], references: [id])
  isMastered         Boolean  @default(false)
  masteredAt         DateTime?
  lastAttemptCorrect Boolean? // null: never answered, false: last was incorrect, true: last was correct
  masteringQuestionId Int?    // The question that led to mastery of this criterion
  masteringQuestion  Question? @relation(fields: [masteringQuestionId], references: [id])

  @@unique([userId, criterionId])
}


// Update to the Question model
model Question {
  // ... existing fields
  
  masteryCriterionId Int?
  masteryCriterion   MasteryCriterion? @relation(fields: [masteryCriterionId], references: [id])
}
```

## 5. Implementation Plan

### Phase 1: Database Schema Implementation

The first step is to modify the Prisma schema (`schema.prisma`) to introduce the new models required for primitive-centric tracking.

1.  **Create `KnowledgePrimitive` Model:** This model will represent the atomic unit of knowledge, including `isTracking` boolean field for user control.
2.  **Create `MasteryCriterion` Model:** This will define the requirements for mastering a `KnowledgePrimitive`, categorized by the "Understand, Use, Explore" (UEE) ladder with `ueeLevel` field.
3.  **Create `UserPrimitiveProgress` Model:** This new table will track each user's spaced repetition data including `currentIntervalStep`, `consecutiveFailures`, and `schedulingMode` fields for enhanced algorithm support.
4.  **Create `UserCriterionMastery` Model:** This new table will track a user's mastery of individual criteria, including `lastAttemptCorrect` field for tracking attempt history.
5.  **Update `Question` Model:** Add single `masteryCriterionId` relationship (not array) to link each question to a specific criterion it tests.
6.  **Update supporting models:** Modify `UserQuestionAnswer`, `ScheduledReview`, and `InsightCatalyst` models with optional primitive links for backwards compatibility.

### Phase 2: Algorithm and Service Layer Refactoring

Next, the backend services and algorithms will be updated to use the new data models. This involves defining the logic for review selection, the daily task generation, spaced repetition scheduling, and UEE progression.

#### **1. The "Today's Tasks" Algorithm**
This algorithm generates a prioritized daily task list by filling three buckets: **Critical**, **Core**, and **Plus**. It relies on querying related models, including `userQuestionAnswer`, to determine priority without needing to modify the `UserPrimitiveProgress` schema. The selection pool for primitives must only include those owned by the current user. Additionally, all queries must filter for primitives where `KnowledgePrimitive.isTracking` is `true`.

*   **Bucket 1: Critical Tasks**
    *   **Pool:** Union of (A) Overdue primitives (`nextReviewAt < TODAY`) and (B) Repeatedly Failed primitives (`consecutiveFailures >= 2`).
    *   **Sorting:**
        1.  **Primary:** Days overdue (descending).
        2.  **Secondary:** UEE Level (ascending: "Understand" > "Use" > "Explore").

*   **Bucket 2: Core Tasks**
    *   **Pool:** Union of (A) Primitives due today, (B) Primitives due tomorrow, and (C) New primitives never reviewed.
    *   **Sorting:**
        1.  **Primary:** Score of the last attempt (ascending). This is determined by finding the most recent `userQuestionAnswer` linked to the primitive and calculating a score percentage (`marks / maxMarks`). This prioritizes items the user struggled with most. New primitives are treated as having a 100% score.
        2.  **Secondary:** UEE Level (ascending).

*   **Bucket 3: Plus Tasks (Stretch Goals)**
    *   **Pool:** Union of (A) UEE Progression Previews (questions from the next UEE level for primitives answered correctly today) and (B) Long-Term Reinforcement (mastered primitives not seen in >90 days).
    *   **Sorting:**
        1.  **Primary:** UEE Level (ascending).
        2.  **Secondary:** `lastReviewedAt` date (ascending, oldest first).

*   **Final Assembly:** A target task count (e.g., 20) is filled by taking all sorted Critical tasks, then filling the rest of the space with sorted Core tasks, and finally with sorted Plus tasks.

#### **2. Spaced Repetition Scheduling Algorithm (Fixed-Interval v3)**
This algorithm uses a fixed ladder of intervals. A user's performance on a given day determines whether they advance, retreat, or maintain their position.

*   **Core Components:**
    *   **Interval Ladder:** A predefined array, e.g., `INTERVALS = [1, 3, 7, 21]` (in days).
    *   **Tracking Model (`UserPrimitiveProgress`):** A new field `currentIntervalStep` (Integer) will be added to track the user's position on the ladder.

*   **Review Logic:**
    *   **Case 1: Correct on First Attempt:**
        *   **Action:** Advance one step up the interval ladder.
        *   **Implementation:** Increment `currentIntervalStep` and set `nextReviewAt` to `now() + INTERVALS[new_step]`.
    *   **Case 2: Incorrect Answer:**
        *   **Action:** Move back one step on the interval ladder and schedule the next review for tomorrow.
        *   **Implementation:** Decrement `currentIntervalStep` (floor at 0) and set `nextReviewAt` to `now() + 1 day`.
    *   **Case 3: Same-Day Correction:**
        *   **Action:** Negate the penalty. The interval step is maintained, and the review clock is reset.
        *   **Implementation:** If a user corrects a mistake on the same day, the `currentIntervalStep` is restored to its pre-session value, and `nextReviewAt` is set to `now() + INTERVALS[current_step]`.

#### **3. UEE Ladder Progression Logic (Weighted Criteria)**
*   A user progresses from "Understand" to "Use" for a primitive based on **weighted mastery** rather than requiring ALL criteria to be mastered.
*   Each `MasteryCriterion` has a `weight` field (1-5 scale) indicating its importance for progression.
*   **Weighted Mastery Calculation:**
    ```
    weightedMastery = (sum of weights for mastered criteria) / (sum of all criteria weights)
    ```
*   **Progression Thresholds:**
    *   "Understand" → "Use": 75% weighted mastery
    *   "Use" → "Explore": 80% weighted mastery  
    *   "Explore" → Complete: 85% weighted mastery
*   When a user meets the weighted threshold for a given UEE level, the `UserPrimitiveProgress` record is updated. The `currentUeeLevel` is advanced, and the `answeredQuestionId` is set to the ID of the question that triggered the level-up.
*   This approach prevents single difficult criteria from blocking progression indefinitely while maintaining high standards for advancement.
*   When a user levels up a primitive's UEE state, the SR state (`currentIntervalStep`, `nextReviewAt`) for that primitive will be reset to start the new level fresh.

#### **4. Manual SR Date Management**
*   Add `schedulingMode` field to `UserPrimitiveProgress` with values "AUTO" or "MANUAL"
*   When `schedulingMode = "MANUAL"`, the SR algorithm must not automatically update `nextReviewAt`
*   Create endpoint `/api/primitives/:primitiveId/set-review-date` for manual scheduling
*   Implement `manuallySetNextReviewDate(userId, primitiveId, newNextReviewAt)` function
*   Manual scheduling overrides automatic SR calculations until user resets to AUTO mode

#### **5. Enhanced Mastery Logic**
*   Mastery requires `lastAttemptCorrect = true` AND current attempt correct (consecutive success)
*   Track `lastAttemptCorrect` in `UserCriterionMastery` for each attempt
*   Only set `isMastered = true` when both conditions are met consecutively
*   If the answer is incorrect, set `lastAttemptCorrect = false` and reset mastery status
*   This ensures consistent mastery rather than single lucky correct answers

### Phase 3: API and AI Integration

Finally, the API endpoints and the role of the AI API will be adjusted.

1.  **API Endpoint Changes:**
    *   **New Endpoints:** Create comprehensive primitive-centric endpoints:
        *   `GET /api/primitives/due`: Fetches daily prioritized list using three-bucket algorithm
        *   `POST /api/primitives/review`: Submits review outcomes for primitives  
        *   `POST /api/primitives/:id/tracking`: Toggles `isTracking` status
        *   `GET /api/primitives`: Lists all user primitives
        *   `GET /api/primitives/:id/details`: Detailed primitive info with criteria and progress
        *   `POST /api/primitives/:id/set-review-date`: Manual review date scheduling
    *   **Deprecation Strategy:** 
        *   `/api/reviews/` routes return `410 Gone` status with migration guidance
        *   Add deprecation logging to monitor continued usage
        *   Update API documentation with comprehensive migration guide
2.  **Evolve AI API's Role:**
    *   The AI API's function will be updated. Instead of only generating a blueprint JSON, it will now be responsible for deconstructing source material into the new database models: `KnowledgePrimitive` and their associated `MasteryCriterion`. This makes the primitives a persistent and integral part of the core application.

## 6. Changes Necessary in the Existing Codebase

This section will detail the specific modifications required across the application to transition from `QuestionSet`-based spaced repetition to the new `KnowledgePrimitive`-centric system.

*   **6.1 Database Schema (`src/db/prisma/schema.prisma`)**
    *   **New Models:**
        *   `KnowledgePrimitive`: `id`, `userId`, `title`, `content`, `isTracking`, `masteryCriteria`, `progress`, `createdAt`, `updatedAt`.
        *   `MasteryCriterion`: `id`, `userId`, `primitiveId`, `description`, `ueeLevel`, `questions`, `mastery`, `createdAt`, `updatedAt`.
        *   `UserPrimitiveProgress`: `id`, `userId`, `primitiveId`, `currentUeeLevel`, `nextReviewAt`, `lastReviewedAt`, `currentIntervalStep`, `consecutiveFailures`, `answeredQuestionId`.
        *   `UserCriterionMastery`: `id`, `userId`, `criterionId`, `isMastered`, `masteredAt`, `masteringQuestionId`.
    *   **Modified Models:**
        *   `Question`: Add `masteryCriterionId` and a relation to `MasteryCriterion`. Remove `uueFocus`.
        *   `QuestionSet`: Remove SR fields: `nextReviewAt`, `lastReviewedAt`, `currentIntervalDays`, `easeFactor`, `lapses`, `trackingMode`, `isTracked`, and all other SR-related metrics. It will now primarily act as a container for questions.
        *   `UserQuestionAnswer`: Make `questionSetId` optional. Add optional relations `primitiveId` and `masteryCriterionId`.
        *   `Note`: Make `questionSetId` optional. Add optional `primitiveId`.
        *   `ScheduledReview`: Make `questionSetId` optional. Add optional `primitiveId`.
    *   **Relationships:**
        *   `KnowledgePrimitive` will have a one-to-many relationship with `MasteryCriterion` and `UserPrimitiveProgress`.
        *   `MasteryCriterion` will have a one-to-many relationship with `Question` and `UserCriterionMastery`.
        *   `User` will have one-to-many relationships with all new models.

*   **6.2 API Endpoints**
    *   **New Endpoints (Primitive-Centric):**
        *   `GET /api/primitives/due`: Fetches a user's daily, prioritized list of primitives for review. Replaces `/api/reviews/today`.
        *   `POST /api/primitives/review`: Submits the outcome of a review session for a primitive. Replaces `POST /api/reviews`.
        *   `POST /api/primitives/:id/tracking`: Toggles the `isTracking` status for a primitive.
        *   `GET /api/primitives`: Lists all primitives for a user.
        *   `GET /api/primitives/:id`: Retrieves detailed information for a single primitive, including its criteria and progress.
    *   **Modified Endpoints:**
        *   `ai-rag.controller` endpoints that generate `QuestionSet` will be updated to generate `KnowledgePrimitive` and `MasteryCriterion` instead.
    *   **Deprecation Strategy:**
        *   The entire `/api/reviews/` route will be deprecated.
        *   A deprecation notice will be added to the API documentation. For a transition period, old endpoints can return a `410 Gone` status with a message pointing to the new API.

*   **6.3 Service Layer Refactoring**
    *   **`todaysTasksPrimitive.service.ts` (New Service):**
        *   Replaces `todaysTasks.service.ts` for primitive-based task generation
        *   Implements three-bucket algorithm (Critical, Core, Plus)
        *   Handles edge cases for users with no historical data
        *   Includes tie-breaking logic for equal scores
        *   Rewrite `getDueSetsForUser` to `getDuePrimitivesForUser` with enhanced querying of `UserPrimitiveProgress`, `UserQuestionAnswer`, and `KnowledgePrimitive`
    *   **`primitiveSR.service.ts` (New Service):**
        *   Implements Fixed-Interval v3 algorithm with interval ladder [1, 3, 7, 21]
        *   Manages `UserPrimitiveProgress` updates based on review outcomes
        *   Handles UEE progression logic and criterion mastery checking
        *   Supports manual scheduling mode with `schedulingMode` field
        *   Tracks `consecutiveFailures` and `lastAttemptCorrect` states
        *   Replaces core functionality from `advancedSpacedRepetition.service.ts`
    *   **`reviewScheduling.service.ts`:**
        *   This service will be refactored to manage manually scheduled reviews for primitives (`ScheduledReview` model) rather than being the core of the SR system.
    *   **`stats.service.ts`:**
        *   Rewrite `fetchQuestionSetStatsDetails` to `fetchPrimitiveStatsDetails`. All stats calculations will now be based on `UserPrimitiveProgress` and `UserCriterionMastery`.
    *   **`ai-rag.service.ts`:**
        *   Update the service to parse AI-generated content into `KnowledgePrimitive` and `MasteryCriterion` entities, persisting them to the database.
    *   **`dashboard.service.ts`:**
        *   Update to fetch and display statistics based on the new primitive-centric models.

*   **6.4 Controller Layer Updates**
    *   **New Controllers:**
        *   `primitive.controller.ts`: Will handle all CRUD and review-related operations for primitives.
    *   **Modified Controllers:**
        *   `review.controller.ts`: To be deprecated and its functionality moved to `primitive.controller.ts`.
        *   `todaysTasks.controller.ts`: Updated to call the new `getDuePrimitivesForUser` service method.
        *   `stats.controller.ts`: Updated to call the new primitive-centric stats services.
        *   `ai.controller.ts` / `ai-rag.controller.ts`: Updated to trigger the new primitive generation process.
        *   `questionset.controller.ts`: Will now only manage non-SR `QuestionSet` entities.

*   **6.5 Types and DTOs**
    *   **New:** `KnowledgePrimitiveDto`, `MasteryCriterionDto`, `UserPrimitiveProgressDto`, `PrimitiveReviewOutcomeDto`.
    *   **Modified:** `QuestionDto` (add `masteryCriterionId`), `UserQuestionAnswerDto` (add `primitiveId`), `NoteDto` (add `primitiveId`).
    *   **Deprecated:** `DueQuestionSet`, `FrontendReviewSubmission`, `QuestionSetStatsDetails`, and other SR-related `QuestionSet` types.

*   **6.6 Testing Strategy**
    *   **Unit Tests:**
        *   Three-bucket algorithm logic with edge cases (no data, ties, empty pools)
        *   Fixed-Interval v3 scheduling algorithm with all review outcomes
        *   UEE progression and mastery logic including rollback scenarios
        *   Manual scheduling functionality and mode switching
        *   Migration script validation with various data scenarios
        *   Enhanced mastery logic with `lastAttemptCorrect` tracking
    *   **Integration Tests:**
        *   All `/api/primitives/*` endpoint testing with success and error cases
        *   Cross-service integration (primitive ↔ algorithm ↔ API)
        *   Authentication and authorization flows for new endpoints
        *   Error handling and edge cases (malformed requests, missing data)
        *   Deprecated endpoint behavior (410 Gone responses)
    *   **End-to-End Tests:**
        *   Complete primitive lifecycle: AI generation → Today's Tasks → Review → Progress tracking
        *   Multi-user scenarios and data isolation verification
        *   Performance testing for daily task generation with large datasets
        *   Migration script testing with rollback scenarios on staging environment
        *   UEE progression across multiple review sessions

*   **6.7 Data Migration Strategy**
    *   A one-time migration script (`scripts/migrate-to-primitive-sr.ts`) will be created.
    *   **Enhanced Migration Logic:**
        1.  Create test database backup before migration
        2.  Iterate through each `QuestionSet` that has `isTracked = true`
        3.  Handle `QuestionSet` with `isTracked = false` (skip or archive as needed)
        4.  For each tracked `QuestionSet`, create one `KnowledgePrimitive`
        5.  For each `Question` in the set, create a corresponding `MasteryCriterion`, linking it to the new primitive
        6.  Create a `UserPrimitiveProgress` record from the `QuestionSet`'s SR data
        7.  Populate `lastAttemptCorrect` based on `UserQuestionAnswer` history analysis
        8.  Set appropriate `schedulingMode` based on existing manual overrides
        9.  Initialize `currentIntervalStep` based on existing `currentIntervalDays`
        10. Validate foreign key relationships post-migration
        11. Handle orphaned Questions and incomplete data gracefully
    *   **Rollback Strategy:**
        *   Maintain backup of pre-migration state with verification
        *   Create rollback script that can restore previous schema
        *   Test rollback process on staging environment thoroughly
        *   Document rollback procedures for production use
        *   Implement partial rollback capability for failed migrations
    *   **Migration Verification:**
        *   Create migration verification tests to ensure data integrity
        *   Validate that all tracked QuestionSets have corresponding primitives
        *   Ensure user progress data is accurately transferred
        *   Test migration script multiple times on staging with various data scenarios

*   **6.8 Frontend Impact (Brief Mention)**
    *   The frontend will need significant updates. This includes creating new UI components for displaying primitive-based tasks, review interfaces, and progress visualizations. All data fetching logic related to spaced repetition will need to be pointed to the new `/api/primitives/*` endpoints. This is a major change that will require coordinated effort with the frontend team.

*   **6.9 Performance and Monitoring Considerations**
    *   **Database Optimization:**
        *   Add indexes on `UserPrimitiveProgress.nextReviewAt` and `userId` for efficient due date queries
        *   Index `UserCriterionMastery.userId` and `criterionId` for fast mastery lookups
        *   Consider composite indexes for complex daily task queries (userId, nextReviewAt, isTracking)
        *   Monitor query performance for three-bucket algorithm with large user datasets
    *   **Caching Strategy:**
        *   Cache daily task results for repeated requests within same session
        *   Cache primitive mastery status for quick UEE level progression checks
        *   Implement query result caching for expensive operations (user stats, progress summaries)
        *   Consider Redis or in-memory caching for frequently accessed primitive data
    *   **Monitoring and Metrics:**
        *   Track daily task generation performance and identify bottlenecks
        *   Monitor primitive review completion rates and user engagement metrics
        *   Alert on migration script execution issues and data inconsistencies
        *   Log deprecated endpoint usage for systematic sunset planning
        *   Monitor database performance impact of new query patterns
        *   Track UEE progression rates and mastery achievement statistics

